<include src="top.xhti">
<use taglib="POEM::Web::TagLib">

<div>
<use class="POEM::DBC">
<set var="curlabels" value="[split(',',#[Input.labels])]">
<set var="curlabelshash" value="{map {$_ => 1} @{#[curlabels]}}">
<set var="curlabelsurl" value="#[Input.labels] ? #[Input.labels].',' : ''">

<set var="curnotlabels" value="[split(',',#[Input.notlabels])]">
<set var="curnotlabelshash" value="{map {$_ => 1} @{#[curnotlabels]}}">
<set var="curnotlabelsurl" value="#[Input.notlabels] ? #[Input.notlabels].',' : ''">

<set var="trusses" value="POEM::DBC->new()->getRecords('SELECT id, name FROM gallery_truss ORDER BY 2 ASC')">
<do expression="push(@{#[trusses]}, {id => 0, name => 'Другие метки'})">
<if condition="#[Input.labels]">
  <use class="Publish::Gallery::Container">
  <set var="rellabels" value="Publish::Gallery::Container::getRelatedLabels(#[Input.labels],#[Input.notlabels],1)">
  <set var="rellabelshash" value="{map {$_->{id} => 1} @{#[rellabels]}}">
</if>
<if condition="#[rellabels] && scalar(@{#[rellabels]})">
<h2>Связанные метки</h2>
<ul class="labels">
<for each="label" from="#[rellabels]">
<set var="ll" value="int(length(#[label.name]) / 2 + 0.9)">
<set var="pl" value="substr(#[label.name],0,#[ll])">
<set var="ml" value="substr(#[label.name],#[ll],#[ll])">
<nb>
<li class="label rel">
<a class="pls" href="?labels=#[curlabelsurl]#[label.id]&notlabels=#[Input.notlabels]" onclick="label(this.href); return false">+#[pl]</a>
<a class="min" href="?labels=#[Input.labels]&notlabels=#[curnotlabelsurl]#[label.id]" onclick="label(this.href); return false">#[ml]-</a>
</li>
</nb>

</for>
</ul>
</if>
<for each="truss" from="#[trusses]">
<set var="trussarg" value="#[truss.id] > 0 ? '= '.#[truss.id] : 'IS NULL'"> 
<set var="labels" value="POEM::DBC->new()->getRecords('SELECT id, name, count(image) as count FROM gallery_label INNER JOIN gallery_label_image ON (label = id) WHERE truss '.#[trussarg].' GROUP BY label ORDER BY 2 ASC')">
<h2>#[truss.name]</h2>
<ul class="labels">
<for each="label" from="#[labels]">
<set var="tag" value="''">
<nb>
<set var="class" value="''">
<set var="url" value="''">
<if condition="#[rellabelshash.#[label.id]]">
<set var="url" value="'labels='.#[curlabelsurl].#[label.id]">
<set var="class" value="' rel'">
</if>
<if condition="#[curlabelshash.#[label.id]]">
<set var="url" value="'labels='.join(',',grep { $_ != #[label.id] } @{#[curlabels]}).'&notlabels='.#[Input.notlabels]">
<set var="tag" value="'!'">
<set var="class" value="' cur'">
</if>
<if condition="#[curnotlabelshash.#[label.id]]">
<set var="url" value="'labels='.#[Input.labels].'&notlabels='.join(',',grep { $_ != #[label.id] } @{#[curnotlabels]})">
<set var="tag" value="'!'">
<set var="class" value="' cur not'">
</if>
<li class="label#[class]">
<if condition="#[tag]">
<a href="?#[url]" onclick="label(this.href); return false" class="op">#[tag]</a>&nbsp;
</if>
<set var="aclass" value="#[label.count] >= 200 ? 'twohundred' : #[label.count] >= 100 || #[label.id] == 424? 'hundred' : #[label.count] >= 60 ? 'sixty' : #[label.count] >= 40 ? 'forty' : #[label.count] >= 20 ? 'twenty' : #[label.count] >= 10 ? 'ten' : #[label.count] >= 2 ? 'two' : 'one'">
<a class="#[aclass]" href="?labels=#[label.id]" title="#[label.count]" onclick="label(this.href); return false">#[label.name]</a></li>
</nb>

</for>
</ul>
</for>

<h2>Другие фильтры</h2>
<form action="/galleries/slideshow.xhtml" id="filter" target="_top">
<input type="hidden" name="-filt.labels" value="#[Input.labels]">
<input type="hidden" name="-filt.notlabels" value="#[Input.notlabels]">
<div>
Снимал: <control name="plain_list(authors,select,=неважно кто)" field="-filt.author" from="#[Input]">, только заслуживающие внимания: <control name="plain_list(starred,select)" field="-filt.starred" from="#[Input]">,
снято после: <input id="fromdate" name="-filt.from" size="10">, но до: <input id="tilldate" name="-filt.till" size="10">
<script type="text/javascript">
$(function(){
  $('#fromdate').datepicker({ dateFormat: 'yymmdd' });
  $('#tilldate').datepicker({ dateFormat: 'yymmdd' });
});
</script>
<input type="submit" value="Показать"/>
</div>
</form>
</div>
<include src="bottom.xhti">

